<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Reverse-engineering the Kayak app with mitmproxy | Shubhro Saha</title>
        <link href='http://fonts.googleapis.com/css?family=Vollkorn' rel='stylesheet' type='text/css'>
        <link href="/static/css/styles.css" rel="stylesheet">
        <link href="/static/css/syntax.css" rel="stylesheet">
        <script type="text/javascript">

            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-3539301-14']);
            _gaq.push(['_trackPageview']);

            (function() {
             var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
             ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
             var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
             })();

        </script>
    </head>
    <body>
        <a href="/"><div class="logo"></div></a>
        <div class="container">
                <br />
    <h2>Reverse-engineering the Kayak app with mitmproxy</h2>
    <p><br />
<img src="/static/kayak-mitmproxy/kayakapp.png" alt="" /></p>

<h3 id="introduction">Introduction</h3>

<p><a href="http://www.kayak.com/">Kayak</a>– the popular fare comparison web site– recently <a href="https://www.kayak.com/labs/api/search/">discontinued</a> their API service. To the dismay of travel hackers, fare comparison APIs frequently <a href="http://stackoverflow.com/questions/10680408/is-there-any-api-for-getting-flight-fare">come and go</a>. But that doesn’t mean we can’t hack together our own Kayak API.</p>

<p>Web scraping is the most common way to imitiate an API, but it’s vulnerable to small changes in the UI. On the other hand, <em>mobile</em> is an area where UI changes are often independent of the supporting server API. Developers often change the “look and feel” of the mobile app, but seldom swap out the server <em>endpoints</em> from which data are obtained. For this reason, reverse-engineering mobile applications is a good way to expose APIs that we can exploit.</p>

<p>In this post, I’ll explain how I used <a href="http://mitmproxy.org/">mitmproxy</a>– a popular network analysis tool– to reverse-engineer the Kayak mobile app. The result is an understanding of important server endpoints that can be accessed programmatically for personal use.</p>

<h3 id="setup">Setup</h3>

<p>My tool of choice for reverse-engineering mobile apps is mitmproxy because it presents network activity in a clean, hackable interface. I used Wireshark for a long time, but I actually couldn’t get the TLS decryption working and the X-Window interface was a little clunky. Mitmproxy functions as a proxy between the mobile device and the rest of the Internet. Any traffic targeting the phone must travel through mitmproxy, allowing us to analyze it.</p>

<p>Getting started with mitmproxy is straightforward:</p>

<pre><code>pip install mitmproxy
</code></pre>

<p>Run <code>mitmproxy</code> to generate certificate files in <code>~/.mitmproxy</code>. From that folder, get the <code>mitmproxy-ca-cert.pem</code> file onto your mobile device by emailing it to yourself, for example. Then follow certificate installation steps for <a href="http://mitmproxy.org/doc/certinstall/ios.html">iOS</a> or <a href="http://mitmproxy.org/doc/certinstall/android.html">Android</a>. Because I used the Kayak iPhone app, I’ll continue this tutorial with iOS.</p>

<p>Mobile apps often encrypt traffic to protect data integrity and confidentiality. Transport Layer Security (TLS) is a popular protocol for implementing this encryption. By installing the certificate on a mobile device, we’re enabling mitmproxy to decrypt its TLS traffic, which includes HTTPS requests and responses. </p>

<p>We need to configure the mobile device to use our computer’s IP address as the proxy. On a Mac, we can find the IP address my opening up System Preferences &gt; Network:</p>

<p><img src="/static/kayak-mitmproxy/ipaddress.png" alt="" /></p>

<p>I configured my iPhone to use my Mac as the proxy by tapping Settings &gt; Wi-Fi &gt; [Network Name], and set HTTP PROXY to ‘Manual’. Then I set the computer’s IP address as the server and 8080 as the port.</p>

<h3 id="recording-kayak-network-activity">Recording Kayak network activity</h3>

<p>We’re now able to observe and save all of the iPhone’s network activity, including those occuring over HTTPS. Let’s record activity for the Kayak iPhone app by running <code>mitmdump -w kayak_flows.out</code> and tapping through the Kayak app as usual. In particular, navigate to Flights &gt; From &gt; Current location &gt; Find Flights. After getting to the search results page, close the Kayak app and exit mitmdump by pressing <code>ctrl+c</code>. We know that, during this usage, the Kayak app must have communicated with the server to learn airports and prices.</p>

<h3 id="browsing-saved-network-activity">Browsing saved network activity</h3>

<p>Having saved the network activity to a file, we can browse the results in a beautiful <a href="http://en.wikipedia.org/wiki/Curses_%28programming_library%29">curses</a> interface with <code>mitmproxy -r kayak_flows.out</code>.</p>

<p><img src="/static/kayak-mitmproxy/mitmproxybasic.png" alt="" /></p>

<p>As we flip through the requests with the arrow keys, the first to jump out is:</p>

<pre><code>GET https://www.kayak.com/k/authajax/?action=registermobile&amp;uuid=[UNIQUE IDENTIFIER]&amp;hash=[A HASH]&amp;model=iPhone4,1&amp;appid=kayakfree&amp;os=8.1.1&amp;msgApiVersion=1&amp;as=0&amp;appdist=adhoc&amp;prefix=`
</code></pre>

<p>I hit &lt;Enter&gt; then &lt;Tab&gt; to view the server response. We discover fields for <code>status</code>, <code>uid</code>, <code>token</code>, <code>sid</code>, and <code>bogus</code>.</p>

<p>Great! Let’s make a note of the <code>uid</code>, <code>token</code>, and <code>sid</code> fields because they might be used in later requests. Back in the request list, we continue to look for interesting URLs. Here’s one: </p>

<pre><code>GET https://www.kayak.com/api/search/V8/flight/start?cabin=e&amp;travelers=1&amp;origin1=BDL&amp;nearbyO1=false&amp;destination1=LAX&amp;nearbyD1=false&amp;depart_date1=12/18/2014&amp;depart_time1=a&amp;depart_date_flex1=exact&amp;_sid_=[SID VALUE]
</code></pre>

<p><img src="/static/kayak-mitmproxy/mitmproxyresponse.png" alt="" /></p>

<p>This request generates a <code>searchid</code> that will probably be used shortly to uniquely identify our choice of airports, dates, and other preferences.</p>

<p>Indeed, that’s the case! Our attention is drawn to:</p>

<pre><code>GET https://www.kayak.com/api/search/V8/flight/poll?currency=USD&amp;searchid=[SEARCH ID]&amp;c=2000&amp;providerData=true&amp;nc=40&amp;includeopaques=true&amp;showAirlineLogos=true&amp;_sid_=[SID VALUE]
</code></pre>

<p>This request includes our <code>searchid</code> and <code>sid</code> from earlier, and the response is a large JSON object that includes airline names, prices, contact, booking URLs, and more. This is exactly the data we’re looking for.</p>

<p><img src="/static/kayak-mitmproxy/mitmproxyprices.png" alt="" /></p>

<h3 id="putting-it-all-together">Putting it all together</h3>

<p>Let’s put these observations together to discern a basic API:</p>

<ul>
  <li>Think of the <code>uuid=[UNIQUE IDENTIFIER]&amp;hash=[A HASH]</code> fields to be like an API key and secret generated when running the mobile app.</li>
  <li>Generate an <code>sid</code> at: <code>https://www.kayak.com/k/authajax/</code></li>
  <li>Generate a <code>searchid</code> at: <code>https://www.kayak.com/api/search/V8/flight/start</code></li>
  <li>Retrieve prices at: <code>https://www.kayak.com/api/search/V8/flight/poll</code></li>
</ul>

<p>You can check out a complete basic client on <a href="https://github.com/shbhrsaha/kayak-mobile-client">GitHub</a>.</p>

<p>The results presented here are far from a complete API, but I hope this tutorial demonstrates the power of reverse-engineering mobile apps. Tools like mitmproxy helps us obtain a level of understanding previously prohibited by the locked-down nature of mobile operating systems. Given how young the mobile space is, there’s never been a better time to do some exploring.</p>

<p>To read more about researching mobile apps with proxies, check out <a href="http://jeffhuang.com/extracting_my_data_from_the_microsoft_band.html">Extracting My Data from the Microsoft Band</a>, <a href="http://silverskylabs.github.io/yakhak/">Yik Hak</a>, and <a href="http://blogs.wsj.com/wtk-mobile/">What They Know Mobile</a>.</p>

    <br />
    <p>
    
        <a href="/categories/software/">Software</a>
        &sdot;
    
    December 2014
    </p>
    <p>
    
        
            <a href="https://news.ycombinator.com/item?id=8778003">Hacker News</a>
        
        
            &sdot;
        
    
        
            <a href="https://www.reddit.com/r/programming/comments/2px1mv/reverseengineering_the_kayak_app_with_mitmproxy/">Reddit</a>
        
        
            &sdot;
        
    
        
            <a href="http://hackaday.com/2015/01/03/reverse-engineering-the-kayak-mobile-api/">Hackaday</a>
        
        
    
    </p>

            <div class="footer">
                <a href="/">Home</a>
                &sdot;
                <a href="mailto:saha@princeton.edu">Email</a>
                &sdot;
                <a target="_blank" href="https://www.facebook.com/shubhro">Facebook</a>
                &sdot;
                <a target="_blank" href="https://twitter.com/shubroski">Twitter</a>
                &sdot;
                <a target="_blank" href="http://www.github.com/shbhrsaha">GitHub</a>
                &sdot;
                <a target="_blank" href="/feed.xml">RSS</a>
            </div>
        </div>
    </body>
</html>
